# CONTRIBUTING

Спасибо, что хотите помочь unicex! Ниже — актуальные правила и рекомендации. Пожалуйста, придерживайтесь их: так код остаётся единообразным и удобным для сопровождения.

## Как сделать Pull Request

1) Подготовка окружения
- Требуется Python 3.12.
- Рекомендуется изоляция окружения: `python -m venv .venv && source .venv/bin/activate`.
- Установка зависимостей:
  - Минимально: `pip install -e .` (библиотека) + инструменты разработки: `pip install ruff pre-commit pyright`.
  - Либо через uv: `uv sync --group dev` (в репозитории есть `uv.lock`).
- Установите git‑хуки: `pre-commit install`.

2) Форк и ветка
- Сделайте форк репозитория и клонируйте свой форк.
- Создайте ветку от `main` по схеме:
  - Новая возможность: `feat/<exchange>-<topic>` (например, `feat/okx-async-client`).
  - Багфикс: `fix/<area>-<short>`.

3) Разработка
- Пишите типизированный код и обрабатывайте ошибки на ключевых ветках логики.
- Следуйте правилам оформления (см. «Правила оформления кода» ниже).
- Не меняйте контракты и базовые абстракции без обсуждения (`unicex/_abc`, `unicex/_base`).

4) Локальная проверка
- Линт и формат: `ruff check --fix . && ruff format .`.
- Тайпчек: `pyright` (конфиг `pyrightconfig.json`).

5) Коммиты и PR
- Стиль коммитов — желательно в духе Conventional Commits:
  - `feat(binance): add futures klines ws`
  - `fix(bitget): handle empty funding rate`
- Откройте Pull Request в основной репозиторий. В описании:
  - Кратко опишите изменения и мотивацию.
  - Укажите, какие эндпоинты/стримы реализованы.
  - Приложите ссылки на документацию API биржи.
  - Добавьте примеры использования, если уместно.

6) Code review
- Будьте готовы к обратной связи по стилю, структуре модулей и унификации.
- Если правки затрагивают общий контракт (унифицированные типы/интерфейсы) — обсудите заранее в issue/PR.

---

## Что обычно будут делать контрибьюторы

Чаще всего — добавлять реализации новых бирж. В этом случае вы НЕ меняете интерфейсы (`unicex/_abc`) и базу (`unicex/_base`), а добавляете конкретную реализацию по образцу существующих (например, `unicex/binance`, `unicex/bybit`, `unicex/bitget`).

Ниже — обязательная структура и правила для реализации биржи на примере Binance.

### Обязательная структура реализации (пример: `unicex/binance`)

- `unicex/<exchange>/adapter.py`
  - Адаптер преобразует сырые ответы/сообщения биржи в унифицированные типы из `unicex/types.py`.
- `unicex/<exchange>/client.py`
  - Асинхронный «сырой» REST‑клиент.
  - ВАЖНО: клиент больше НЕ оборачивает все HTTP‑эндпоинты 1:1. Реализуйте только основные категории методов: рынок (market data), аккаунт, ордера, позиции. Для доступа ко всем прочим эндпоинтам обязателен единый generic‑метод (см. ниже «Политика оборачивания REST»).
- `unicex/<exchange>/websocket_manager.py`
  - Менеджер сырых WebSocket‑стримов (без адаптации сообщений).
- `unicex/<exchange>/uni_client.py`
  - Унифицированный клиент, работает поверх `client.py`, возвращая унифицированные типы через `adapter.py`.
- `unicex/<exchange>/uni_websocket_manager.py`
  - Унифицированный менеджер WebSocket: оборачивает колбэки и передаёт в них адаптированные сообщения.
- `unicex/<exchange>/user_websocket.py` (опционально)
  - Приватные стримы: создание/продление/закрытие listenKey/токенов и т. п.
- `unicex/<exchange>/__init__.py`
  - Явный экспорт основных классов (`__all__`).

Дополнительно:
- `unicex/enums.py` — таймфреймы, биржи, рынки.
- `unicex/mapper.py` — регистрируйте новые реализации в маппере.
- `tests/` — исполняемые примеры/ад‑хок скрипты. Для новой биржи ориентируйтесь на `tests/_template/*` и существующие каталоги бирж.

### Политика оборачивания REST (сырой клиент `client.py`)

- Наследуйтесь от `unicex._base.BaseClient`.
- Оборачивайте ТОЛЬКО основные категории HTTP‑методов:
  - рынок (market data), аккаунт, ордера, позиции;
  - давайте осмысленные имена и докстринги «Описание + ссылка на документацию»;
  - не покрывайте 1:1 весь API биржи.
- Для всех прочих эндпоинтов обязателен единый generic‑метод, который пользователь может вызывать по своему усмотрению.
  - Примеры существующих сигнатур: `request(method, endpoint, params, signed)` (Bybit), `request(method, url, params, data, signed)` (Binance), `request(method, endpoint, params, data, signed)` (Bitget).
  - Допускаются небольшие различия по URL/endpoint и `data/params` в зависимости от требований биржи, но метод должен быть явно документирован и стабилен.
- Подпись, заголовки, ретраи, таймауты, прокси — реализуйте внутри клиента через приватные методы и базовый `BaseClient._make_request`.

### Adapter (`adapter.py`)

- Наследуйтесь от соответствующего интерфейса адаптера и реализуйте ВСЕ методы.
- Каждый публичный метод — `@staticmethod` + обязательно оберните в декоратор `@catch_adapter_errors` из `unicex.utils`.
  - Это унифицирует обработку ошибок преобразования и возвращает понятное исключение `AdapterError`.
- Возвращайте строго унифицированные типы из `unicex/types.py`:
  - `TickerDailyDict`, `KlineDict`, `TradeDict`, `AggTradeDict`, `OpenInterestDict` и т. д.
- Фьючерсные версии методов именуйте с префиксом `futures_`.
- Докстринги оформляйте в стиле проекта (см. раздел «Докстринги»).

### Сырой WebSocket‑менеджер (`websocket_manager.py`)

- Отвечает за создание «сырых» WebSocket‑подписок и управление жизненным циклом.
- Формирование URL/подписок и специфичные флаги — в этом же классе (без адаптации сообщений).
- Докстринги: «Описание + ссылка на документацию стрима».
- Именование методов соответствует стримам биржи (`trade`, `agg_trade`, `klines`, ...) с вариантами для spot/futures, где применимо.

### Унифицированный клиент (`uni_client.py`)

- Наследуйтесь от `unicex._abc.IUniClient[Client]`.
- Реализуйте `_client_cls` и поле/свойство `adapter` (кешируйте по необходимости).
- Публичные методы используют «сырой» клиент, затем адаптер:
  - пример: `raw = await self._client.ticker_price(); return self.adapter.last_price(raw)`.
- Для таймфреймов используйте `Timeframe.to_exchange_format(Exchange.<EXCHANGE>)`.
- Докстринги — в стиле проекта: описание + параметры + «Возвращает».

### Унифицированный менеджер вебсокетов (`uni_websocket_manager.py`)

- Наследуйтесь от `unicex._abc.IUniWebsocketManager`.
- В конструкторе создайте «сырой» `WebsocketManager` и `Adapter`.
- Каждый метод оборачивает пользовательский callback через `self._make_wrapper(<adapter_fn>, callback)` и вызывает соответствующий метод «сырого» `WebsocketManager`.
- Следите за семантикой `symbol`/`symbols` и используйте унифицированные таймфреймы.

### Пользовательские вебсокеты (`user_websocket.py`, опционально)

- Если биржа поддерживает приватные стримы, реализуйте по образцу существующих:
  - создание/продление/закрытие listenKey/токенов,
  - автопродление в фоне, безопасный рестарт при ошибках.

---

## Докстринги

Общий стиль для публичных функций/методов:

```
"""Описание.

- Параметры:
Название параметра (`тип параметра`): Описание параметра

Возвращает:
  `Тип возвращаемого параметра`: Описание возвращаемого параметра.
"""
```

- Методы базового клиента (сырые REST/WS API, не унифицированные):

```
"""Описание.

Ссылка на документацию
"""
```

- Приватные методы (начинаются с `_`):

```
"""Описание."""
```

Пожалуйста, соблюдайте русский язык описаний, типизацию и последовательность разделов.

---

## Правила оформления кода

- Типизация обязательна. Используйте типы/`TypedDict` из `unicex/types.py` для унифицированных структур.
- `__all__` в каждом модуле с публичным API.
- Импорты отсортированы (ruff/isort), кавычки — двойные, ширина строки — 100.
- Линтинг/форматирование: `ruff check --fix . && ruff format .`.
- Тайпчек: `pyright` (режим basic).
- Именование параметров — `snake_case`. Не используйте однобуквенные имена.
- Исключения:
  - В адаптерах не прокидывайте сырые исключения: используйте `@catch_adapter_errors` (вернёт `AdapterError`).
  - Для неподдерживаемых операций — `NotSupported`.
  - Для приватных эндпоинтов без ключей — `NotAuthorized`.
  - Ошибки HTTP/JSON — через `ResponseError` (через базовый клиент).
- Не меняйте `unicex/_abc` и `unicex/_base` без предварительного обсуждения.

---

## Интеграция новой биржи — чеклист

- [ ] Создан пакет `unicex/<exchange>/`.
- [ ] Реализован `adapter.py` (все методы интерфейса адаптера, декоратор `@catch_adapter_errors`).
- [ ] Реализованы `client.py` (только основные категории: рынок, аккаунт, ордера, позиции) и `websocket_manager.py`.
- [ ] В `client.py` есть единый generic‑метод `request(...)` для неохваченных эндпоинтов (задокументированная сигнатура и поведение).
- [ ] Реализованы `uni_client.py` и `uni_websocket_manager.py`.
- [ ] (Опционально) Реализован `user_websocket.py` для приватных стримов.
- [ ] Добавлены экспорты в `unicex/<exchange>/__init__.py`.
- [ ] При необходимости — маппинги/регистрация в `unicex/mapper.py` и актуализация таймфреймов в `unicex/enums.py`.
- [ ] Локальная проверка: `ruff`, `pyright`, запуск примеров/скриптов из `tests/`.
- [ ] PR с описанием и ссылками на документацию эндпоинтов.

---

## Вопросы и обсуждения

Если вы не уверены в структуре реализации, формате WS‑сообщений или маппинге таймфреймов — создайте issue или черновой PR с вопросами. Поможем подобрать правильное место и стиль реализации.

