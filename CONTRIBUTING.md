# CONTRIBUTING

Спасибо, что хотите помочь unicex! Ниже описаны правила и рекомендации для контрибьюторов. Пожалуйста, придерживайтесь их — так мы сохраним код единообразным и удобным для сопровождения.

## Как сделать Pull Request

1) Подготовка окружения
- Требуется Python 3.12.
- Рекомендуется изоляция окружения: `python -m venv .venv && source .venv/bin/activate`.
- Установка зависимостей:
  - Минимально: `pip install -e .` (библиотека) + инструменты разработки: `pip install ruff pre-commit pyright`.
  - Либо через uv: `uv sync --group dev` (если используете uv; в репозитории есть `uv.lock`).
- Установите git‑хуки: `pre-commit install`.

2) Форк и ветка
- Сделайте форк репозитория и клонируйте свой форк.
- Создайте ветку от `main` по схеме:
  - Новая возможность: `feat/<exchange>-<topic>` (например, `feat/okx-async-client`).
  - Багфикс: `fix/<area>-<short>`.

3) Разработка
- Пишите типизированный код, покрывайте ключевые ветки логики обработкой ошибок.
- Следуйте правилам оформления (см. ниже «Правила оформления кода»).
- Не меняйте интерфейсы и базовые абстракции без обсуждения (модули `unicex/_abc` и `unicex/_base`).

4) Локальная проверка
- Линт и формат: `ruff check --fix . && ruff format .`.
- Тайпчек: `pyright` (конфиг `pyrightconfig.json`).

5) Коммиты и PR
- Стиль коммитов — желательно в духе Conventional Commits:
  - `feat(binance): add futures klines ws`
  - `fix(bitget): handle empty funding rate`
- Откройте Pull Request в основной репозиторий. В описании:
  - Кратко опишите изменения и мотивацию.
  - Укажите, какие эндпоинты/стримы реализованы.
  - Приложите ссылки на документацию API биржи.
  - Добавьте примеры использования, если уместно.

6) Code review
- Будьте готовы к обратной связи: правкам по стилю, структуре модулей и унификации.
- Если правки затрагивают общий контракт (унифицированные типы/интерфейсы) — обсудите заранее в issue/PR.

---

## Что обычно будут делать контрибьюторы

Чаще всего — добавлять реализации новых бирж. В этом случае вы НЕ меняете интерфейсы (`unicex/_abc`) и базу (`unicex/_base`), а добавляете конкретную реализацию по образцу существующих (например, `unicex/binance` или `unicex/bitget`).

Ниже — обязательная структура и правила для реализации биржи на примере Binance.

### Обязательная структура реализации (пример: `unicex/binance`)

- `unicex/<exchange>/adapter.py`
  - Адаптер преобразует сырой ответ/API‑сообщения биржи в унифицированные типы (`unicex/types.py`).
- `unicex/<exchange>/_mixins/`
  - Общий функционал и константы для REST/WebSocket этой биржи: базовые URL, подготовка подписи, генерация stream‑URL и т.д.
- `unicex/<exchange>/asyncio/`
  - `client.py` — асинхронный клиент биржи (сырой, «не унифицированный»), методы 1:1 с эндпоинтами API.
  - `websocket_manager.py` — менеджер сырых WS‑стримов (без адаптации сообщений).
  - `uni_client.py` — унифицированный клиент, поверх `client.py`, возвращает унифицированные типы с помощью `adapter.py`.
  - `uni_websocket_manager.py` — унифицированный менеджер WS: оборачивает колбэки и подает на них адаптированные сообщения.
  - `user_websocket.py` (если нужен) — приватные стримы: создание/продление/закрытие listenKey/токенов.
- `unicex/<exchange>/sync/` (опционально)
  - Аналогичная структура для синхронной версии (если делаете синхронную реализацию).
- `unicex/<exchange>/__init__.py`
  - Явный экспорт основных классов (`__all__`) и реэкспорт синхронных/асинхронных реализаций.

Дополнительно:
- `unicex/enums.py` — при необходимости добавьте маппинг таймфреймов в `Timeframe.mapping[Exchange.<EXCHANGE>]`.
- `unicex/mapper.py` — зарегистрируйте новый клиент/WS‑менеджер в соответствующих мапперах (async/sync).

### Adapter (`adapter.py`)

- Наследуйтесь от `unicex._abc.IAdapter` и реализуйте ВСЕ методы.
- Каждый публичный метод — `@staticmethod` + обязательно оберните в декоратор `@catch_adapter_errors` из `unicex.utils`.
  - Это унифицирует обработку ошибок преобразования и возвращает понятное исключение `AdapterError`.
- Возвращайте строго унифицированные типы из `unicex/types.py`:
  - `TickerDailyDict`, `KlineDict`, `TradeDict`, `AggTradeDict` и т.д.
- Называйте фьючерсные версии методов с префиксом `futures_` (как в Binance): `futures_klines`, `futures_trades_message`, и т.д.
- Докстринги оформляйте в стиле проекта (см. раздел «Докстринги»).

Пример сигнатуры и оформления:

```
class Adapter(IAdapter):
    """Адаптер для унификации данных с <EXCHANGE> API."""

    @staticmethod
    @catch_adapter_errors
    def klines(raw_data: list[list]) -> list[KlineDict]:
        """Преобразует сырой ответ ... в унифицированный формат.

        Параметры:
            raw_data (`list[list]`): Сырой ответ с биржи.

        Возвращает:
            `list[KlineDict]`: Список свечей.
        """
        ...
```

### Асинхронный клиент (`asyncio/client.py`)

- Наследуйтесь от `unicex._base.asyncio.BaseClient` и используйте собственный `ClientMixin` в `_<exchange>/_mixins/client.py`.
- Методы — это «сырые» эндпоинты 1:1 с API биржи; не выполняют адаптацию, только HTTP.
- Подпись запросов/заголовки/таймстемпы/recvWindow и пр. — оформляйте в миксине (см. Binance: `_mixins/client.py`), а в `client.py` вызывайте единый `_make_request`.
- Докстринги для таких методов — «Описание + ссылка на документацию эндпоинта».
- Группируйте методы по разделам API (как в Binance: public/private, spot/futures) с понятными заголовками‑комментариями.

Мини‑пример:

```
class Client(ClientMixin, BaseClient):
    """Клиент для работы с <EXCHANGE> API."""

    async def depth(self, symbol: str, limit: int | None = None) -> dict:
        """Получение книги ордеров.

        https://.../docs/<link-to-endpoint>
        """
        url = self._BASE_SPOT_URL + "/api/v3/depth"
        params = {"symbol": symbol, "limit": limit}
        return await self._make_request("GET", url, params=params)
```

### Менеджер «сырых» вебсокетов (`asyncio/websocket_manager.py`)

- Отвечает за создание `Websocket` с правильными URL; без адаптации сообщений.
- Логика сборки URL — в миксине (`_mixins/websocket_manager.py`), сам вебсокет создаётся через `unicex._base.asyncio.Websocket`.
- Докстринги: «Описание + ссылка на документацию стрима».
- Именование методов соответствует стримам биржи (`trade`, `agg_trade`, `klines`, ...) и имеет спотовые/фьючерсные варианты.

### Унифицированный клиент (`asyncio/uni_client.py`)

- Наследуйтесь от `unicex._abc.asyncio.IUniClient[Client]`.
- Реализуйте `@cached_property adapter` и `_client_cls`.
- Публичные методы используют «сырой» клиент, а затем адаптер:
  - пример: `raw = await self._client.ticker_price(); return self.adapter.last_price(raw)`.
- Для передачи таймфреймов используйте `Timeframe.to_exchange_format(Exchange.<EXCHANGE>)`.
- Докстринги — в стиле проекта: описание + параметры + «Возвращает».

### Унифицированный менеджер вебсокетов (`asyncio/uni_websocket_manager.py`)

- Наследуйтесь от `unicex._abc.asyncio.IUniWebsocketManager`.
- В конструкторе создайте «сырой» `WebsocketManager` и `Adapter`.
- Каждый метод должен оборачивать пользовательский callback через `self._make_wrapper(<adapter_fn>, callback)` и вызывать соответствующий метод «сырого» `WebsocketManager`.
- Следите за семантикой symbol/symbols (они взаимоисключаемы) и используйте унифицированные таймфреймы.

### Пользовательские вебсокеты (`asyncio/user_websocket.py`, опционально)

- Если биржа поддерживает приватные стримы, реализуйте класс по образцу Binance:
  - создание/продление/закрытие listenKey/токенов,
  - автопродление в фоне, безопасный рестарт при ошибках.
- Общие утилиты и константы — в `_<exchange>/_mixins/user_websocket.py`.

---

## Докстринги

Общий стиль для публичных функций/методов:

```
"""Описание.

- Параметры:
Название параметра (`тип параметра`): Описание параметра

Возвращает:
  `Тип возвращаемого параметра`: Описание возвращаемого параметра.
"""
```

- Методы базового клиента (сырые REST/WS API, не унифицированные):

```
"""Описание.

Ссылка на документацию
"""
```

- Приватные методы (начинаются с `_`):

```
"""Описание."""
```

Пожалуйста, соблюдайте русский язык описаний (как в кодовой базе), типизацию и последовательность разделов.

---

## Правила оформления кода

- Типизация обязательна. Используйте `TypedDict` из `unicex/types.py` для унифицированных структур.
- `__all__` в каждом модуле с публичным API.
- Импорты отсортированы (isort/ruff), кавычки — двойные, ширина строки — 100.
- Линтинг/форматирование: `ruff check --fix . && ruff format .`.
- Тайпчек: `pyright` (режим basic).
- Именование параметров — `snake_case`. Не используйте однобуквенные имена.
- Исключения:
  - В адаптерах не прокидывайте сырые исключения: используйте `@catch_adapter_errors` (вернёт `AdapterError`).
  - Для неподдерживаемых операций — `NotSupported`.
  - Для приватных эндпоинтов без ключей — `NotAuthorized`.
  - Ошибки HTTP/JSON — через `ResponseError` (используйте базовый клиент).
- Не меняйте `unicex/_abc` и `unicex/_base` без предварительного обсуждения.

---

## Интеграция новой биржи — чеклист

- [ ] Создан пакет `unicex/<exchange>/` с подпакетами `asyncio/` (+ `sync/` при необходимости) и `_mixins/`.
- [ ] Реализован `adapter.py` (все методы `IAdapter`, декоратор `@catch_adapter_errors`).
- [ ] Реализован асинхронный сырой `client.py` и `websocket_manager.py`.
- [ ] Реализован `asyncio/uni_client.py` и `asyncio/uni_websocket_manager.py`.
- [ ] (Опционально) Реализован `asyncio/user_websocket.py` для приватных стримов.
- [ ] Добавлены экспорты в `unicex/<exchange>/__init__.py`.
- [ ] Добавлены маппинги в `unicex/mapper.py` (async/sync, если есть).
- [ ] При необходимости — добавлен маппинг таймфреймов в `unicex/enums.py`.
- [ ] Локальная проверка: `ruff`, `pyright`, запуск примеров/скриптов.
- [ ] PR с описанием и ссылками на документацию эндпоинтов.

---

## Вопросы и обсуждения

Если вы не уверены в структуре для новой биржи, формате сообщений WS или маппинге таймфреймов — создайте issue или черновой PR с вопросами. Мы поможем подобрать правильное место и стиль реализации.
